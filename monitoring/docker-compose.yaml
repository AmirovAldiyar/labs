version: "3"

networks:
    loki:

volumes:
    grafana-data: {}
    loki-data: {}
    promtail-data: {}
    prometheus-data: {}

services:
    app_python:
        image: aldeeyar/lab2:latest
        container_name: app_python
        ports:
            - "80:80"

    loki:
        image: grafana/loki:2.6.1
        ports:
            - "3100:3100"
        command: -config.file=/etc/loki/local-config.yaml
        networks:
            - loki

    promtail:
        image: grafana/promtail:2.6.1
        volumes:
            - /var/log:/var/log
        command: -config.file=/etc/promtail/config.yml
        networks:
            - loki

    grafana:
        image: grafana/grafana:latest
        ports:
            - "3000:3000"
        networks:
            - loki

    prometheus:
        image: prom/prometheus:latest
        container_name: prometheus
        restart: unless-stopped
        volumes:
          - ./prometheus.yml:/etc/prometheus/prometheus.yml
        command:
          - '--config.file=/etc/prometheus/prometheus.yml'
          - '--storage.tsdb.path=/prometheus'
          - '--web.console.libraries=/etc/prometheus/console_libraries'
          - '--web.console.templates=/etc/prometheus/consoles'
          - '--web.enable-lifecycle'
        ports:
          - "9090:9090"
        networks:
            - loki
